const firebaseConfig = { 'apiKey': "AIzaSyA4x1fNeC6r6znsm_HMJU1sJTVjeyIIIZU", 'authDomain': "zoyearrtyweb.firebaseapp.com", 'projectId': "zoyearrtyweb", 'storageBucket': "zoyearrtyweb.firebasestorage.app", 'messagingSenderId': "1033442222787", 'appId': "1:1033442222787:web:cf008858fd8f3309f87876" };

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();

// --- INJECT CUSTOM STYLES ---
const style = document.createElement('style');
style.innerHTML =`
  .artwork-service-id { font-size: 12px; color: var(--accent); margin-bottom: 8px; font-weight: 600; background: rgba(200, 155, 60, 0.1); padding: 4px 8px; border-radius: 4px; display: inline-block; }
  .artwork-service-id-badge { font-size: 0.75rem; color: var(--accent); background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); padding: 2px 8px; border-radius: 4px; display: inline-block; margin-bottom: 6px; font-weight: 600; font-family: monospace; }
  .sale-badge { position: absolute; top: 10px; right: 10px; background-color: #e74c3c; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: block !important; }
  .sold-out-badge { position: absolute; top: 10px; right: 10px; background-color: #333; border: 1px solid #e74c3c; color: #fff; padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; z-index: 21; box-shadow: 0 4px 10px rgba(231,76,60,0.4); text-transform: uppercase; letter-spacing: 1px; }
  .price-wrapper { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.3; }
  .old-price { text-decoration: line-through; opacity: 0.6; font-size: 0.85em; color: var(--text-light); }
  .new-price { color: var(--accent); font-weight: 600; font-size: 1.1em; }
  .price { font-weight: 700; font-size: 1.2rem; color: var(--accent); }
  .size-option { display: inline-block; padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; margin: 0 8px 8px 0; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
  .size-option:hover { border-color: var(--accent); background: rgba(0,0,0,0.02); }
  .size-option.selected { background-color: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 4px 10px rgba(200, 155, 60, 0.3); }
  .size-option.disabled { opacity: 0.5; cursor: not-allowed; background: #eee; color: #999; text-decoration: line-through; border-color: #ddd; pointer-events: none; }
  #featured-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; margin: 0 auto; }
  .artwork-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 15px; overflow: hidden; transition: var(--transition); backdrop-filter: blur(10px); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; }
  .swipe-gallery { position: relative; width: 100%; height: 250px; overflow: hidden; border-radius: 15px 15px 0 0; cursor: pointer; }
  .artwork-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
  .artwork-title { font-size: 1.4rem; margin-bottom: 10px; }
  .artwork-artist { color: var(--accent); margin-bottom: 15px; font-weight: 500; }
  .artwork-price { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
  .btn-disabled { opacity: 0.6; cursor: not-allowed; background: #333 !important; color: #ccc !important; border-color: #555 !important; }
  
  /* NEW SLIDER STYLES FOR YOU MIGHT ALSO LIKE */
  .swipe-container { display: flex; width: 100%; height: 100%; transition: transform 0.3s ease; }
  .swipe-slide { min-width: 100%; height: 100%; flex-shrink: 0; }
  .swipe-slide img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
  .gallery-indicators { position: absolute; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; gap: 6px; z-index: 5; }
  .gallery-indicator { width: 6px; height: 6px; border-radius: 50%; background: rgba(255, 255, 255, 0.5); cursor: pointer; transition: all 0.3s ease; }
  .gallery-indicator.active { background: var(--accent); transform: scale(1.3); }
  .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; opacity: 0; transition: 0.3s; font-size: 10px; }
  .swipe-gallery:hover .gallery-nav { opacity: 1; }
  .gallery-prev { left: 5px; }
  .gallery-next { right: 5px; }
  .image-count { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; z-index: 5; }

  @media (max-width: 768px) { 
      #featured-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 15px !important; } 
      .artwork-card { height: auto !important; } 
      .swipe-gallery { height: auto !important; aspect-ratio: 3/4 !important; border-radius: 8px 8px 0 0 !important; } 
      .artwork-info { padding: 10px !important; } 
      .artwork-title { font-size: 13px !important; margin-bottom: 5px !important; line-height: 1.2; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: 32px; } 
      .artwork-artist { display: none !important; } 
      .artwork-service-id { font-size: 10px; padding: 2px 6px; margin-bottom: 5px; }
      .artwork-price { margin-top: 8px !important; flex-direction: column !important; align-items: flex-start !important; gap: 8px !important; width: 100%; } 
      .price, .new-price { font-size: 14px !important; } 
      .add-to-cart { padding: 8px 12px !important; font-size: 12px !important; width: 100% !important; margin: 0 !important; } 
      .gallery-nav, .image-count, .gallery-indicators { display: none !important; } 
  }
`;
document.head.appendChild(style);

let cart = JSON.parse(localStorage.getItem('arrtyCart')) || [];
let currentArtwork = null;
let selectedSize = null;
let currentDisplayedPrice = 0; 
let productListener = null; 
let deliveryRules = [];
let appliedCoupon = JSON.parse(localStorage.getItem('arrtyAppliedCoupon')) || null;
let discountAmount = 0;
let threeJSScene = { scene: null, camera: null, renderer: null, particles: null };
let liveViewInterval = null;

document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (productId) {
        setupProductListener(productId); 
        loadFeaturedProducts(productId);
    } else {
        // If on the main index page, load featured products without a current ID
        loadFeaturedProducts(null);
    }

    setupEventListeners();
    loadAllSettings();
    updateCartDisplay();
    setupThemeToggle();
    initThreeJS();
});

function setupEventListeners() {
    document.getElementById('cart-icon').addEventListener("click", () => openModal('cart-modal'));
    document.getElementById("cart-modal-close").addEventListener("click", () => closeModal('cart-modal'));
    document.getElementById('clear-cart-btn').addEventListener("click", clearCart);
    document.getElementById("mobile-menu-btn").addEventListener('click', toggleMobileMenu);
    document.getElementById("mobile-menu-close").addEventListener("click", toggleMobileMenu);
    document.getElementById("mobile-menu-overlay").addEventListener("click", toggleMobileMenu);
}

function setupProductListener(id) {
    if (productListener) productListener(); 
    productListener = db.collection('artworks').doc(id).onSnapshot((doc) => {
        if (!doc.exists) {
            document.querySelector('main').innerHTML = `<div class="container" style="text-align:center; padding: 100px;"><h2>Product Unavailable</h2><p>This item may have been removed.</p><a href="index.html" class="btn btn-primary">Back to Gallery</a></div>`;
            return;
        }
        const data = doc.data();
        if(data.status === 'unavailable' || data.status === 'hidden') {
             document.querySelector('main').innerHTML = `<div class="container" style="text-align:center; padding: 100px;"><h2>Product Unavailable</h2><p>This item is currently hidden.</p><a href="index.html" class="btn btn-primary">Back to Gallery</a></div>`;
             return;
        }
        currentArtwork = { id: doc.id, ...data };
        populateProductPage(currentArtwork);
    }, (error) => console.error("Error:", error));
}

function populateProductPage(artwork) {
    document.title = `${artwork.title} | Arrty Trails`;

    document.getElementById('product-category').textContent = artwork.category || 'Art';
    document.getElementById('product-title').textContent = artwork.title;
    document.getElementById('product-artist').textContent = `by ${artwork.artist || 'Artist'}`;
    document.getElementById('product-description').textContent = artwork.description || '';
    
    const span = document.getElementById('product-service-id-span');
    if (artwork.serviceId && artwork.serviceId !== 'N/A') {
        span.innerHTML = `<p class="artwork-service-id">Service ID: ${artwork.serviceId}</p>`;
        document.getElementById('detail-service-id').style.display = 'block';
    } else {
        document.getElementById('detail-service-id').style.display = 'none';
    }

    window.basePrice = artwork.price;
    window.baseDiscount = artwork.discountPrice;
    
    setupImageSlider(artwork.imageUrls);

    const sizeContainer = document.getElementById('size-selector-container');
    const sizeOptionsDiv = document.getElementById('size-options');
    sizeOptionsDiv.innerHTML = ''; 

    let sizesData = artwork.sizes;
    if (typeof sizesData === 'string') {
        const list = sizesData.split(',').filter(s => s.trim() !== '');
        sizesData = list.map((s, i) => ({ name: s.trim(), price: null, isDefault: i === 0, status: 'available' }));
    }

    if(Array.isArray(sizesData)) {
        sizesData = sizesData.filter(s => s.status !== 'unavailable');
    }

    if (sizesData && Array.isArray(sizesData) && sizesData.length > 0) {
        sizeContainer.style.display = 'block';
        
        let defaultSize = sizesData.find(s => s.status !== 'sold_out') || sizesData[0];
        selectedSize = defaultSize.status !== 'sold_out' ? defaultSize.name : null;
        
        if (defaultSize && defaultSize.price) { updatePriceUI(defaultSize.price, null); } 
        else { updatePriceUI(window.basePrice, window.baseDiscount); }

        sizesData.forEach(s => {
            const chip = document.createElement('div');
            chip.className = 'size-option';
            
            if (s.status === 'sold_out') {
                chip.classList.add('disabled');
                chip.textContent = `${s.name} (Sold Out)`;
            } else {
                chip.textContent = s.name;
                if (s.name === selectedSize) chip.classList.add('selected');
                
                chip.onclick = () => {
                    document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
                    chip.classList.add('selected');
                    selectedSize = s.name;
                    if (s.price) { updatePriceUI(s.price, null); } 
                    else { updatePriceUI(window.basePrice, window.baseDiscount); }
                };
            }
            sizeOptionsDiv.appendChild(chip);
        });
    } else {
        sizeContainer.style.display = 'none';
        selectedSize = "Standard";
        updatePriceUI(window.basePrice, window.baseDiscount);
    }

    setupLiveView(artwork);
    updateStockStatus(artwork);
}

function updatePriceUI(price, discountPrice) {
    currentDisplayedPrice = (discountPrice && discountPrice > 0 && discountPrice < price) ? discountPrice : price;

    const priceEl = document.getElementById('product-price');
    const container = document.querySelector('.main-image-container');
    
    if (discountPrice && discountPrice > 0 && discountPrice < price) {
        priceEl.innerHTML = `<span class="old-price">Rs ${price.toLocaleString()}</span> <span class="new-price">Rs ${discountPrice.toLocaleString()}</span>`;
        if(container && !container.querySelector('.sale-badge')) {
            const badge = document.createElement('div');
            badge.className = 'sale-badge';
            badge.innerText = 'SALE';
            container.appendChild(badge);
        }
    } else {
        priceEl.innerHTML = `<span class="new-price">Rs ${price.toLocaleString()}</span>`;
        const badge = container ? container.querySelector('.sale-badge') : null;
        if(badge) badge.remove();
    }
}

// ---------------------------------------------------------
// STRICT AUTO-LOCK STOCK LOGIC (PRODUCT PAGE)
// ---------------------------------------------------------
function updateStockStatus(artwork) {
    const btn = document.getElementById('add-to-cart-btn');
    const stockDisplay = document.getElementById('stock-display');
    const unavailableMsg = document.getElementById('unavailable-msg');
    let isPurchasable = true;
    let buttonText = "Add to Cart";
    let stockStatusHTML = "";
    
    const status = artwork.status || 'available';
    const stock = (artwork.stock !== undefined && artwork.stock !== null && artwork.stock !== "") ? parseInt(artwork.stock) : 0;

    // LOGIC: Only lock if Status is strictly 'sold_out'
    // We ignore the '0' stock value for locking because 0 = Default/Available
    if (status === 'sold_out') { 
        isPurchasable = false; 
        buttonText = "Sold Out"; 
        stockStatusHTML = `<span style="color:#e74c3c; font-weight:bold;"><i class="fas fa-times-circle"></i> Item Sold Out</span>`; 
    }
    else if (status === 'unavailable' || status === 'hidden') { 
        isPurchasable = false; 
        buttonText = "Unavailable"; 
    }
    else {
        // If stock is set to a high number (like 1-5), show the "Hurry" message
        // But if it is 0, we treat it as "In Stock" (Default)
        if (stock > 0 && stock < 5) {
            stockStatusHTML = `<span style="color:#e74c3c; font-weight:bold;"><i class="fas fa-fire"></i> Hurry! Only ${stock} left.</span>`;
        } else {
            stockStatusHTML = `<span style="color:#27ae60; font-weight:bold;"><i class="fas fa-check-circle"></i> In Stock</span>`;
        }
        isPurchasable = true;
    }

    stockDisplay.innerHTML = stockStatusHTML;
    btn.textContent = buttonText;
    
    if (isPurchasable) { 
        btn.disabled = false; 
        btn.classList.remove("btn-disabled");
        btn.classList.add("btn-outline"); 
        btn.onclick = () => addToCart(artwork); 
        unavailableMsg.style.display = 'none'; 
    } else { 
        btn.disabled = true; 
        btn.classList.remove("btn-outline");
        btn.classList.add("btn-disabled"); 
        unavailableMsg.textContent = "This item is currently sold out and cannot be added to cart."; 
        unavailableMsg.style.display = 'block'; 
    }
}

// ---------------------------------------------------------
// LIVE GALLERY / MAIN PAGE SYNC (ONSNAPSHOT) WITH SWIPE LOGIC
// ---------------------------------------------------------
function loadFeaturedProducts(currentId) {
    db.collection("artworks").orderBy("createdAt", "desc").limit(10).onSnapshot(snap => {
        const grid = document.getElementById('featured-grid');
        if(!grid) return;
        
        grid.innerHTML = '';
        let count = 0;
        
        snap.docs.forEach(doc => {
            if (doc.id === currentId || count >= 4) return;
            const art = { id: doc.id, ...doc.data() };
            if (art.status === 'unavailable' || art.status === 'hidden') return;
            
            count++;
            const isPurchasable = art.status !== 'sold_out';
            const btnText = isPurchasable ? "Add to Cart" : "Sold Out";
            const btnClass = isPurchasable ? "btn-outline" : "btn-disabled";
            
            const hasMultipleImages = art.imageUrls && art.imageUrls.length > 1;
            
            let imagesHtml = '';
            if (art.imageUrls && art.imageUrls.length > 0) {
                imagesHtml = art.imageUrls.map(url => `<div class="swipe-slide"><img src="${url}"></div>`).join('');
            } else {
                imagesHtml = `<div class="swipe-slide"><img src="https://placehold.co/300x400?text=No+Image"></div>`;
            }

            let extraUI = '';
            if (hasMultipleImages) {
                extraUI = `
                    <div class="gallery-indicators">${art.imageUrls.map((_, i) => `<div class="gallery-indicator ${i === 0 ? 'active' : ''}"></div>`).join('')}</div>
                    <div class="gallery-nav gallery-prev"><i class="fas fa-chevron-left"></i></div>
                    <div class="gallery-nav gallery-next"><i class="fas fa-chevron-right"></i></div>
                    <div class="image-count">+${art.imageUrls.length - 1}</div>
                `;
            }

            const card = document.createElement("div");
            card.className = "artwork-card";
            card.innerHTML = `
                <div class="swipe-gallery" data-id="${art.id}">
                    ${art.discountPrice ? '<div class="sale-badge">SALE</div>' : ''}
                    ${!isPurchasable ? '<div class="sold-out-badge">SOLD OUT</div>' : ''}
                    <div class="swipe-container">${imagesHtml}</div>
                    ${extraUI}
                </div>
                <div class="artwork-info" onclick="window.location.href='product.html?id=${art.id}'" style="cursor:pointer;">
                    <h3 class="artwork-title">${art.title}</h3>
                    <p class="artwork-artist">By ${art.artist || 'Artist'}</p>
                    <div class="artwork-price">
                        <span class="price">Rs ${art.price.toLocaleString()}</span>
                        <button class="btn ${btnClass}" id="featured-btn-${art.id}" ${!isPurchasable ? 'disabled' : ''}>${btnText}</button>
                    </div>
                </div>`;
            grid.appendChild(card);
            
            if (isPurchasable) {
                document.getElementById(`featured-btn-${art.id}`).addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    addToCart(art);
                });
            }

            if (hasMultipleImages) initSwipeGallery(card, art.id);
            else card.querySelector('.swipe-gallery').onclick = () => window.location.href=`product.html?id=${art.id}`;
        });
    });
}

function initSwipeGallery(cardElement, artId) {
    const container = cardElement.querySelector(".swipe-container");
    const indicators = cardElement.querySelectorAll(".gallery-indicator");
    const prevBtn = cardElement.querySelector(".gallery-prev");
    const nextBtn = cardElement.querySelector(".gallery-next");
    let currentIndex = 0;
    const totalSlides = indicators.length;

    function updateGallery() {
        container.style.transform = `translateX(-${currentIndex * 100}%)`;
        indicators.forEach((ind, i) => ind.classList.toggle('active', i === currentIndex));
    }

    if (nextBtn) nextBtn.addEventListener('click', e => { e.stopPropagation(); currentIndex = (currentIndex + 1) % totalSlides; updateGallery(); });
    if (prevBtn) prevBtn.addEventListener("click", e => { e.stopPropagation(); currentIndex = (currentIndex - 1 + totalSlides) % totalSlides; updateGallery(); });

    // Mobile Touch Swiping Logic
    let startPos = 0;
    let isDragging = false;

    container.addEventListener('touchstart', e => { startPos = e.touches[0].clientX; isDragging = false; }, {passive: true});
    container.addEventListener('touchmove', e => { isDragging = true; }, {passive: true});
    container.addEventListener('touchend', e => {
        if (isDragging) {
            let endPos = e.changedTouches[0].clientX;
            let diff = startPos - endPos;
            if (diff > 30) { currentIndex = (currentIndex + 1) % totalSlides; updateGallery(); }
            else if (diff < -30) { currentIndex = (currentIndex - 1 + totalSlides) % totalSlides; updateGallery(); }
            else { window.location.href = `product.html?id=${artId}`; }
        } else {
            // Treat as a normal click to open product if not dragged
            window.location.href = `product.html?id=${artId}`;
        }
    });

    // Desktop click fallback
    container.addEventListener('click', e => {
        window.location.href = `product.html?id=${artId}`;
    });
}

function addToCart(artwork) {
    if (document.getElementById('size-selector-container') && document.getElementById('size-selector-container').style.display !== 'none' && !selectedSize) {
        alert("Please select a valid size.");
        return;
    }

    const stock = (artwork.stock !== undefined && artwork.stock !== null && artwork.stock !== "") ? parseInt(artwork.stock) : null;
    
    // Final security check before adding
    if (artwork.status === 'sold_out' || (stock !== null && stock <= 0)) {
        alert("Sorry, this item is sold out!");
        return;
    }

    const finalPrice = currentDisplayedPrice; 
    const cartItemId = `${artwork.id}-${selectedSize}`;
    const existing = cart.find(item => item.cartId === cartItemId);
    
    if (existing && stock !== null && existing.quantity >= stock) {
        alert(`Limit reached. Only ${stock} left in stock.`);
        return;
    }

    if (existing) {
        existing.quantity++;
        existing.price = finalPrice; 
    } else {
        cart.push({
            cartId: cartItemId,
            id: artwork.id,
            title: artwork.title,
            price: finalPrice, 
            image: artwork.imageUrls ? artwork.imageUrls[0] : '',
            quantity: 1,
            size: selectedSize,
            serviceId: artwork.serviceId || 'N/A'
        });
    }

    updateCartDisplay();
    showNotification(`${artwork.title} added to cart!`);
}

function updateCartDisplay() {
    localStorage.setItem('arrtyCart', JSON.stringify(cart));
    localStorage.setItem('arrtyAppliedCoupon', JSON.stringify(appliedCoupon));
    
    const count = cart.reduce((s, i) => s + i.quantity, 0);
    const cartCountEl = document.getElementById('cart-count');
    const cartItemCountEl = document.getElementById("cart-item-count");
    if(cartCountEl) cartCountEl.textContent = count;
    if(cartItemCountEl) cartItemCountEl.textContent = `(${cart.length} items)`;
    
    const container = document.getElementById("cart-items-container");
    if(!container) return;
    container.innerHTML = '';
    
    if (cart.length === 0) {
        container.innerHTML = "<div style='text-align:center;padding:20px;'>Your cart is empty</div>";
    } else {
        cart.forEach(item => {
            const itemEl = document.createElement("div");
            itemEl.className = "cart-item";
            itemEl.innerHTML = `
                <img src="${item.image || 'https://placehold.co/60x45'}" class="cart-item-img">
                <div class="cart-item-details">
                    <h4>${item.title} <span style="font-size:0.8em; opacity:0.7">(${item.size})</span></h4>
                    <p>Rs ${item.price.toLocaleString()} x ${item.quantity}</p>
                </div>
                <button class="cart-item-remove" onclick="removeFromCart('${item.cartId}')"><i class="fas fa-trash"></i></button>`;
            container.appendChild(itemEl);
        });
    }
    
    calculateTotals();
    
    const couponSection = document.getElementById('coupon-section');
    if(!couponSection) return;
    if (appliedCoupon) {
        couponSection.innerHTML = `<div class="applied-coupon-info" style="display:flex; justify-content:space-between; background: rgba(39, 174, 96, 0.15); border: 1px solid #27ae60; padding: 10px; border-radius: 8px; color: #2ecc71;"><span>"${appliedCoupon.code}" applied! (-${appliedCoupon.discount}%)</span><button class="remove-coupon-btn" style="background:none; border:none; color:#e74c3c; cursor:pointer;" onclick="removeCoupon()"><i class="fas fa-times-circle"></i></button></div>`;
    } else {
        couponSection.innerHTML = `<div class="coupon-form" style="display:flex; gap:10px;"><input type="text" id="coupon-code-input" class="form-control" placeholder="Enter coupon code" style="flex:1;"><button onclick="applyCoupon()" class="btn btn-primary" style="padding:0 15px;">Apply</button></div>`;
    }
}

function calculateTotals() {
    const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
    const deliveryFee = calculateDeliveryFee(subtotal);
    const totalBeforeDiscount = subtotal + deliveryFee;

    discountAmount = appliedCoupon ? totalBeforeDiscount * (appliedCoupon.discount / 100) : 0;

    const row = document.getElementById('cart-discount-row');
    if(row) {
        row.style.display = appliedCoupon ? 'flex' : 'none';
        document.getElementById('cart-discount-price').textContent = `- Rs ${discountAmount.toFixed(2)}`;
    }

    const grandTotal = totalBeforeDiscount - discountAmount;

    const subEl = document.getElementById("cart-subtotal-price");
    const delEl = document.getElementById("cart-delivery-fee");
    const grandEl = document.getElementById("cart-grand-total-price");
    
    if(subEl) subEl.textContent = "Rs " + subtotal.toLocaleString();
    if(delEl) delEl.textContent = "Rs " + deliveryFee.toLocaleString();
    if(grandEl) grandEl.textContent = "Rs " + grandTotal.toFixed(2);
    
    const btn = document.getElementById('checkout-btn');
    if(btn) btn.disabled = cart.length === 0;
}

function removeFromCart(id) { cart = cart.filter(i => i.cartId !== id); updateCartDisplay(); }
function clearCart() { if (confirm("Are you sure you want to empty your cart?")) { cart = []; appliedCoupon = null; updateCartDisplay(); } }
function calculateDeliveryFee(subtotal) { if (subtotal <= 0) return 0; for (const rule of deliveryRules) if (subtotal >= rule.min && subtotal <= rule.max) return rule.fee; return 0; }

async function applyCoupon() {
    const code = document.getElementById('coupon-code-input').value.trim().toUpperCase();
    if (!code) return showNotification("Please enter a code.", true);
    try {
        const snapshot = await db.collection('coupons').where('code', '==', code).limit(1).get();
        if (snapshot.empty) throw new Error("Invalid coupon code.");
        const data = snapshot.docs[0].data();
        if (data.status !== 'active' || (data.usageLimit && data.totalUses >= data.usageLimit)) throw new Error("Coupon invalid or expired.");
        
        appliedCoupon = { code: data.code, discount: data.discount, id: snapshot.docs[0].id };
        updateCartDisplay();
        showNotification(`Coupon "${code}" applied!`);
    } catch (e) { showNotification(e.message, true); }
}

function removeCoupon() { appliedCoupon = null; showNotification("Coupon removed."); updateCartDisplay(); }

function setupLiveView(artwork) {
    const eyeContainer = document.getElementById('live-view-container');
    if(!eyeContainer) return;
    let adminEyeCount = parseInt(artwork.eyeCount) || 0;
    let isEyeEnabled = artwork.eyeCounterEnabled !== false;

    if (isEyeEnabled && adminEyeCount > 0) {
        eyeContainer.style.display = 'flex';
        eyeContainer.style.alignItems = 'center';
        eyeContainer.style.color = '#e74c3c';
        eyeContainer.style.marginBottom = '15px';
        eyeContainer.style.fontWeight = '500';

        if (!liveViewInterval) {
            let offset = Math.floor(Math.random() * 5) - 2; 
            let currentViews = adminEyeCount + offset;
            if(currentViews < 2) currentViews = 2;
            eyeContainer.innerHTML = `<i class="fas fa-eye"></i> <span style="font-weight:bold; margin:0 4px;">${currentViews}</span> people are viewing this right now`;

            liveViewInterval = setInterval(() => {
                const change = Math.floor(Math.random() * 6) - 2; 
                currentViews += change;
                let minBound = Math.max(2, adminEyeCount - 8);
                let maxBound = adminEyeCount + 8;
                if (currentViews < minBound) currentViews = minBound;
                if (currentViews > maxBound) currentViews = maxBound;
                eyeContainer.innerHTML = `<i class="fas fa-eye"></i> <span style="font-weight:bold; margin:0 4px;">${currentViews}</span> people are viewing this right now`;
            }, 10000); 
        }
    } else {
        eyeContainer.style.display = 'none';
        if(liveViewInterval) { clearInterval(liveViewInterval); liveViewInterval = null; }
    }
}

function setupImageSlider(urls) {
    const slider = document.getElementById('main-image-slider');
    const thumbs = document.getElementById('product-thumbnails-container');
    const prevBtn = document.getElementById('slider-prev');
    const nextBtn = document.getElementById('slider-next');
    
    if(!slider || !thumbs) return;
    slider.innerHTML = ''; thumbs.innerHTML = '';
    if(!urls) return;
    
    urls.forEach(url => { 
        const img = document.createElement('img'); 
        img.src = url; 
        slider.appendChild(img); 
    });
    
    if(urls.length > 1) {
        if(prevBtn) prevBtn.style.display = 'block';
        if(nextBtn) nextBtn.style.display = 'block';
        
        let idx = 0;
        urls.forEach((url, i) => { 
            const t = document.createElement('img'); 
            t.src = url; 
            t.onclick = () => { idx = i; update(); }; 
            thumbs.appendChild(t); 
        });
        
        const update = () => { 
            slider.style.transform = `translateX(-${idx * 100}%)`; 
            thumbs.querySelectorAll('img').forEach((img, i) => img.classList.toggle('active', i === idx)); 
        };
        
        if(prevBtn) prevBtn.onclick = () => { idx = (idx - 1 + urls.length) % urls.length; update(); };
        if(nextBtn) nextBtn.onclick = () => { idx = (idx + 1) % urls.length; update(); };
        
        // Touch Swipe logic for the main product slider
        let startPos = 0;
        let isDragging = false;

        slider.addEventListener('touchstart', e => { startPos = e.touches[0].clientX; isDragging = false; }, {passive: true});
        slider.addEventListener('touchmove', e => { isDragging = true; }, {passive: true});
        slider.addEventListener('touchend', e => {
            if (isDragging) {
                let endPos = e.changedTouches[0].clientX;
                let diff = startPos - endPos;
                if (diff > 40) { idx = (idx + 1) % urls.length; update(); }
                else if (diff < -40) { idx = (idx - 1 + urls.length) % urls.length; update(); }
            }
        });
        
    } else {
        if(prevBtn) prevBtn.style.display = 'none';
        if(nextBtn) nextBtn.style.display = 'none';
    }
}

function showNotification(message, isError=false) {
    const el = document.createElement("div");
    el.textContent = message;
    el.style.cssText = `position:fixed; top:80px; right:20px; padding:15px; border-radius:8px; color:white; background:${isError ? '#e74c3c' : '#2ecc71'}; z-index:10001; font-weight:600; box-shadow: 0 4px 10px rgba(0,0,0,0.3);`;
    document.body.appendChild(el);
    setTimeout( () => el.remove(), 3000);
}

function loadAllSettings() {
    db.collection("siteSettings").onSnapshot(snap => {
        const s = {}; snap.forEach(d => s[d.id] = d.data());
        deliveryRules = s.deliveryRules?.rules || [];
        updateCartDisplay();
        if(s.activeTheme) document.body.dataset.theme = s.activeTheme.themeId || 'theme-default';
        applyBackgroundStyle(s.backgroundStyle);
        applyMarquee(s.marquee);
        updateContactInfo(s.contactInfo);
        updateSocialLinks(s.socialLinks);
    });
}

function applyBackgroundStyle(styleData) {
    const canvas = document.getElementById('three-canvas');
    if(!canvas) return;
    if (styleData && styleData.type === '3d') {
        canvas.style.display = 'block'; document.body.style.background = '';
    } else if (styleData && styleData.type === 'gradient') {
        canvas.style.display = 'none'; document.body.style.background = `linear-gradient(45deg, ${styleData.color1}, ${styleData.color2})`;
    } else if (styleData && styleData.type === 'solid') {
        canvas.style.display = 'none'; document.body.style.background = styleData.color1;
    }
}

function toggleMobileMenu() { document.getElementById("mobile-menu").classList.toggle("active"); document.getElementById("mobile-menu-overlay").classList.toggle("active"); }
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function setupThemeToggle() { const t = document.getElementById('theme-toggle'); if(t) t.onclick = () => { document.body.classList.toggle('light-theme'); }; }
function initThreeJS() { const c=document.getElementById("three-canvas"); if(!c)return; threeJSScene.scene=new THREE.Scene(); threeJSScene.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000); threeJSScene.renderer=new THREE.WebGLRenderer({canvas:c,alpha:true}); threeJSScene.renderer.setSize(window.innerWidth,window.innerHeight); const g=new THREE.BufferGeometry(); const p=new Float32Array(500*3); for(let i=0;i<p.length;i++)p[i]=(Math.random()-0.5)*10; g.setAttribute("position",new THREE.BufferAttribute(p,3)); threeJSScene.particles=new THREE.Points(g,new THREE.PointsMaterial({size:0.02,vertexColors:true})); threeJSScene.scene.add(threeJSScene.particles); threeJSScene.camera.position.z=5; function a(){requestAnimationFrame(a);threeJSScene.particles.rotation.x+=0.0005;threeJSScene.particles.rotation.y+=0.001;threeJSScene.renderer.render(threeJSScene.scene,threeJSScene.camera);} a(); window.addEventListener("resize",()=>{threeJSScene.camera.aspect=window.innerWidth/window.innerHeight;threeJSScene.camera.updateProjectionMatrix();threeJSScene.renderer.setSize(window.innerWidth,window.innerHeight);}); }
function updateContactInfo(d) { if(d) { const email = document.getElementById("footer-email"); const phone = document.getElementById("footer-phone"); const address = document.getElementById("footer-address"); const copy = document.getElementById("footer-copyright"); if(email) email.textContent = d.email; if(phone) phone.textContent = d.phone; if(address) address.textContent = d.address; if (copy && d.copyright) copy.innerHTML = d.copyright; } }
function updateSocialLinks(d) { if(d) { const c = document.getElementById('footer-social-links'); if(c) { c.innerHTML = ''; if(d.instagram) c.innerHTML+=`<a href="${d.instagram}"><i class="fab fa-instagram"></i></a>`; if(d.facebook) c.innerHTML+=`<a href="${d.facebook}"><i class="fab fa-facebook-f"></i></a>`; } } }
function applyMarquee(d) { if(d && d.enabled) { const b = document.getElementById('marquee-banner'); if(b) { b.querySelector('p').textContent = d.text; b.style.backgroundColor = d.backgroundColor; b.style.color = d.textColor; b.style.display='block'; document.body.classList.add('marquee-visible'); } } }
